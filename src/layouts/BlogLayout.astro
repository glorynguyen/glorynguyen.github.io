---
import BaseLayout from './BaseLayout.astro';
import BlogHeader from '../components/BlogHeader.astro';
import BlogFooter from '../components/BlogFooter.astro';
import '../styles/blog.css';

interface Props {
    title: string;
    description: string;
    keywords?: string;
    ogUrl?: string;
    canonicalUrl?: string;
    publishedDate?: string;
    structuredData?: object;
}

const {
    title,
    description,
    keywords,
    ogUrl,
    canonicalUrl,
    publishedDate,
    structuredData,
} = Astro.props;
---

<BaseLayout
    title={title}
    description={description}
    keywords={keywords}
    ogType="article"
    ogTitle={title}
    ogDescription={description}
    ogUrl={ogUrl}
    canonicalUrl={canonicalUrl}
    structuredData={structuredData}
>
    <Fragment slot="head">
        {publishedDate && <meta property="article:published_time" content={publishedDate}>}
        <meta property="article:author" content="Vinh Nguyen (Vincent)">
    </Fragment>

    <a href="#main-content" class="skip-link">Skip to main content</a>

    <BlogHeader />

    <main id="main-content" class="blog-main">
        <slot />
    </main>

    <BlogFooter />

    <script is:inline>
        const I18n = (function() {
            const SUPPORTED_LANGUAGES = ['en', 'vi'];
            const DEFAULT_LANGUAGE = 'en';
            const STORAGE_KEY = 'blog-language';

            function detectBrowserLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                const langCode = browserLang.split('-')[0].toLowerCase();
                return SUPPORTED_LANGUAGES.includes(langCode) ? langCode : DEFAULT_LANGUAGE;
            }

            function getLanguage() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored && SUPPORTED_LANGUAGES.includes(stored)) {
                    return stored;
                }
                return detectBrowserLanguage();
            }

            function setLanguage(lang) {
                if (!SUPPORTED_LANGUAGES.includes(lang)) {
                    console.warn(`Unsupported language: ${lang}. Using default.`);
                    lang = DEFAULT_LANGUAGE;
                }
                localStorage.setItem(STORAGE_KEY, lang);
                applyLanguage(lang);
                return lang;
            }

            function applyLanguage(lang) {
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang]').forEach(el => {
                    if (el.getAttribute('data-lang') === lang) {
                        el.style.display = '';
                        el.removeAttribute('hidden');
                    } else {
                        el.style.display = 'none';
                        el.setAttribute('hidden', '');
                    }
                });
                document.querySelectorAll('[data-lang-switch]').forEach(btn => {
                    const btnLang = btn.getAttribute('data-lang-switch');
                    btn.classList.toggle('active', btnLang === lang);
                    btn.setAttribute('aria-pressed', btnLang === lang);
                });
                window.dispatchEvent(new CustomEvent('languagechange', { detail: { language: lang } }));
            }

            function toggleLanguage() {
                const current = getLanguage();
                const currentIndex = SUPPORTED_LANGUAGES.indexOf(current);
                const nextIndex = (currentIndex + 1) % SUPPORTED_LANGUAGES.length;
                return setLanguage(SUPPORTED_LANGUAGES[nextIndex]);
            }

            function init() {
                const lang = getLanguage();
                applyLanguage(lang);
                document.querySelectorAll('[data-lang-switch]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetLang = btn.getAttribute('data-lang-switch');
                        setLanguage(targetLang);
                    });
                });
                return lang;
            }

            return {
                init,
                getLanguage,
                setLanguage,
                toggleLanguage,
                detectBrowserLanguage,
                SUPPORTED_LANGUAGES,
                DEFAULT_LANGUAGE
            };
        })();

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => I18n.init());
        } else {
            I18n.init();
        }
    </script>
</BaseLayout>
